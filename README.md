this code is very ugly and hacky, I might clean it up at some point
